<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Optimizador SaaS Puno</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.2.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.2.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
  <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css" type="text/css">

  <style>
    body, html { height: 100%; margin: 0; font-family: sans-serif; background-color: #f8f9fa; overflow: hidden; }
    
    /* --- ESTILOS DE LOGIN --- */
    #auth-container { 
      height: 100%; display: flex; align-items: center; justify-content: center; 
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); position: relative; z-index: 2000;
    }
    .auth-card { 
      background: white; padding: 2rem; border-radius: 12px; width: 90%; max-width: 400px; 
      box-shadow: 0 10px 25px rgba(0,0,0,0.2); 
    }

    /* --- ESTILOS DE LA APP (Ocultos al inicio) --- */
    #app-container { display: none; height: 100%; width: 100%; position: relative; }
    #map { height: 100%; width: 100%; position: absolute; top: 0; left: 0; }
    
    /* --- SIDEBAR RESPONSIVO --- */
    .sidebar { 
      position: absolute; 
      background: rgba(255,255,255,0.98); 
      padding: 15px; 
      z-index: 10; 
      overflow-y: auto; 
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
      transition: transform 0.3s ease-in-out, opacity 0.3s;
      
      /* Estilo Desktop por defecto */
      top: 10px; 
      left: 10px; 
      width: 350px; 
      max-height: calc(100vh - 20px); 
      border-radius: 8px; 
    }

    .sidebar.hidden {
      transform: translateX(-370px);
      opacity: 0;
      pointer-events: none;
    }

    #btn-menu-float {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 9;
      display: none; 
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    @media (max-width: 768px) {
      .sidebar {
        top: auto; bottom: 0; left: 0; width: 100%; max-height: 60vh; 
        border-radius: 20px 20px 0 0; padding-bottom: 30px;
      }
      .sidebar.hidden { transform: translateY(100%); }
      #btn-menu-float { top: 10px; left: 10px; }
    }
    
    .loading-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 3000; display: none; justify-content: center; align-items: center; }
    .itinerary-item-clickable { cursor: pointer; transition: background 0.2s; padding: 10px; border-bottom: 1px solid #eee; }
    .itinerary-item-clickable:hover { background: #f1f1f1; }
    .parada-item { display: flex; justify-content: space-between; padding: 8px 5px; border-bottom: 1px solid #f0f0f0; }
    
    /* Estilos mejorados para resultados de b칰squeda */
    .geocode-result-item { 
      padding: 10px; 
      border-bottom: 1px solid #eee; 
      cursor: pointer; 
      transition: background 0.2s;
    }
    .geocode-result-item:hover { background-color: #e9ecef; }
    .geocode-result-item strong { color: #0d6efd; }
    .crosshair-cursor { cursor: crosshair !important; }
  </style>
</head>
<body>

  <div id="auth-container">
    <div class="auth-card">
      <h3 class="text-center mb-4 text-primary fw-bold"><i class="bi bi-map-fill"></i> Ruta Puno SaaS</h3>
      <div id="auth-error" class="alert alert-danger" style="display:none;"></div>
      <div id="login-form">
        <h5 class="mb-3">Iniciar Sesi칩n</h5>
        <form onsubmit="handleLogin(event)">
            <input type="email" id="login-email" class="form-control mb-2" placeholder="Email" required>
            <input type="password" id="login-pass" class="form-control mb-3" placeholder="Contrase침a" required>
            <button type="submit" class="btn btn-primary w-100 mb-2">Entrar</button>
        </form>
        <div class="text-center"><small>쯅o tienes cuenta? <a href="#" onclick="toggleAuth('register')">Reg칤strate</a></small></div>
      </div>
      <div id="register-form" style="display:none;">
        <h5 class="mb-3">Crear Cuenta</h5>
        <form onsubmit="handleRegister(event)">
            <input type="text" id="reg-name" class="form-control mb-2" placeholder="Nombre Completo">
            <input type="email" id="reg-email" class="form-control mb-2" placeholder="Email" required>
            <input type="password" id="reg-pass" class="form-control mb-3" placeholder="Contrase침a" required>
            <button type="submit" class="btn btn-success w-100 mb-2">Registrarse</button>
        </form>
        <div class="text-center"><small>쯏a tienes cuenta? <a href="#" onclick="toggleAuth('login')">Inicia Sesi칩n</a></small></div>
      </div>
    </div>
  </div>

  <div id="app-container">
    <div id="map"></div>
    <div class="loading-overlay text-white" id="loading">
        <div class="spinner-border" role="status"></div><h4 class="ms-3">Cargando...</h4>
    </div>

    <button id="btn-menu-float" class="btn btn-light btn-lg rounded-circle" onclick="toggleSidebar()">
      <i class="bi bi-list"></i>
    </button>

    <div class="sidebar shadow" id="main-sidebar">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="m-0 text-primary fw-bold">Planificador</h5>
        <div class="d-flex gap-2">
            <button onclick="toggleSidebar()" class="btn btn-sm btn-light text-secondary" title="Minimizar">
                <i class="bi bi-chevron-down d-md-none"></i>
                <i class="bi bi-chevron-left d-none d-md-inline"></i>
            </button>
            <button onclick="logout()" class="btn btn-outline-danger btn-sm" title="Salir">
                <i class="bi bi-box-arrow-right"></i>
            </button>
        </div>
      </div>
      <hr class="my-2">
      
      <h6>1. Inicio (GPS)</h6> <small id="start-coords" class="text-muted">Esperando GPS...</small>
      <div id="pin-instruction" class="alert alert-info py-1 mt-2" style="display:none; font-size:0.9rem;">
        <i class="bi bi-hand-index-thumb"></i> Haz clic en el mapa para fijar la ubicaci칩n...
      </div>

      <h6 class="mt-3">Cargar Ruta</h6> 
      <select id="select-ruta-guardada" class="form-select form-select-sm"></select>
      
      <h6 class="mt-3">2. Mis Destinos</h6> 
      <div id="lista-paradas" class="mb-2"></div>
      <button class="btn btn-success btn-sm w-100" data-bs-toggle="modal" data-bs-target="#paradaModal" onclick="abrirModalNuevaParada()">
        <i class="bi bi-plus-circle"></i> A침adir Parada
      </button>

      <div class="row g-2 mt-3">
        <div class="col"><button id="btn-optimizar" class="btn btn-primary w-100"><i class="bi bi-broadcast"></i> Optimizar</button></div>
        <div class="col"><button id="btn-limpiar" class="btn btn-outline-danger w-100"><i class="bi bi-x-circle"></i> Limpiar</button></div>
      </div>

      <hr>
      <h6>3. Resultado</h6>
      <button id="btn-guardar-ruta" class="btn btn-info w-100 mb-2 text-white" style="display:none;"><i class="bi bi-save"></i> Guardar Ruta</button>
      <div id="itinerario-total" class="alert alert-primary py-1" style="display:none;"></div>
      <div id="itinerario-error" class="alert alert-danger py-1" style="display:none;"></div>
      <div id="itinerario-lista" class="list-group"></div>
    </div>
  </div>

  <div class="modal fade" id="paradaModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
    <div class="modal-header bg-light">
      <h5 class="modal-title" id="modalTitle">游늸 Nueva Parada</h5>
      <button class="btn-close" data-bs-dismiss="modal"></button>
    </div>
    <div class="modal-body">
      <form id="paradaForm">
        <input type="hidden" id="paradaId">
        
        <label class="form-label fw-bold">Buscar lugar en Puno:</label>
        <div class="input-group mb-2">
          <input type="text" class="form-control" id="geocode-search-query" placeholder="Ej: Plaza de Armas, Terminal...">
          <button class="btn btn-primary" type="button" id="btn-geocode-search" onclick="handleGeocodeSearch()">
            <i class="bi bi-search"></i>
          </button>
        </div>
        <div id="geocode-results" class="list-group mb-3 shadow-sm" style="max-height: 150px; overflow-y: auto;"></div>

        <hr>
        <label class="form-label fw-bold">Detalles:</label>
        <input type="text" id="paradaNombre" class="form-control mb-2" placeholder="Nombre del lugar (se rellena solo)" required>
        
        <div class="d-grid mb-2">
          <button type="button" class="btn btn-outline-secondary btn-sm" id="btn-pin-map">
            <i class="bi bi-crosshair"></i> O selecciona en el mapa
          </button>
        </div>

        <div class="row mb-2">
          <div class="col"><input type="number" step="any" id="paradaLat" class="form-control form-control-sm bg-light" placeholder="Lat" readonly required></div>
          <div class="col"><input type="number" step="any" id="paradaLng" class="form-control form-control-sm bg-light" placeholder="Lng" readonly required></div>
        </div>
        
        <div class="row mb-2">
          <div class="col"><label class="form-label" style="font-size:0.8rem">Apertura</label><input type="time" id="paradaInicio" class="form-control" required></div>
          <div class="col"><label class="form-label" style="font-size:0.8rem">Cierre</label><input type="time" id="paradaFin" class="form-control" required></div>
        </div>
        
        <label class="form-label" style="font-size:0.8rem">Tiempo visita (min)</label>
        <input type="number" id="paradaServicio" class="form-control" value="30">
        
        <button type="submit" class="btn btn-success w-100 mt-3 fw-bold">Guardar Parada</button>
      </form>
    </div>
  </div></div></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // --- CONFIGURACI칍N ---
    const API_URL = ""; 
    const MAPBOX_TOKEN = "pk.eyJ1IjoiamVmZjI2MTMyNiIsImEiOiJjbWh5aWgyeW4wMmVuMmtxYjVzb25xeHRhIn0.h8HOF9YxlXYJYnYATTX3Kg";
    
    mapboxgl.accessToken = MAPBOX_TOKEN;
    let map, userStartLocation, startMarker, paradasGlobal=[], rutasGlobal=[], paradasOptimizadasActuales=[], paradaModal, isPinningLocation=false;
    let tempSearchMarker = null;
    let token = localStorage.getItem('token');

    // --- INICIO ---
    document.addEventListener("DOMContentLoaded", () => {
      if (token) { iniciarApp(); } else { document.getElementById('auth-container').style.display = 'flex'; }
      
      paradaModal = new bootstrap.Modal(document.getElementById('paradaModal'));
      document.getElementById("paradaForm").addEventListener("submit", handleGuardarParada);
      document.getElementById("btn-optimizar").addEventListener("click", handleOptimizar);
      document.getElementById("btn-limpiar").addEventListener("click", limpiarPlan);
      document.getElementById("btn-pin-map").addEventListener("click", startPinningLocation);
      document.getElementById("btn-geocode-search").addEventListener("click", handleGeocodeSearch);
      document.getElementById("select-ruta-guardada").addEventListener("change", handleCargarRuta);
      document.getElementById("btn-guardar-ruta").addEventListener("click", handleGuardarRuta);
      
      document.getElementById("geocode-search-query").addEventListener("keypress", function(event) {
        if (event.key === "Enter") { event.preventDefault(); handleGeocodeSearch(); }
      });
    });

    function toggleSidebar() {
        const sidebar = document.getElementById('main-sidebar');
        const floatBtn = document.getElementById('btn-menu-float');
        sidebar.classList.toggle('hidden');
        if (sidebar.classList.contains('hidden')) { floatBtn.style.display = 'block'; } else { floatBtn.style.display = 'none'; }
    }

    // --- AUTENTICACI칍N ---
    function toggleAuth(view) {
      document.getElementById('login-form').style.display = view === 'login' ? 'block' : 'none';
      document.getElementById('register-form').style.display = view === 'register' ? 'block' : 'none';
      document.getElementById('auth-error').style.display = 'none';
    }
    async function handleLogin(e) {
      e.preventDefault();
      const email = document.getElementById('login-email').value; const pass = document.getElementById('login-pass').value;
      const formData = new FormData(); formData.append('username', email); formData.append('password', pass);
      try {
        const res = await fetch(`${API_URL}/token`, { method: 'POST', body: formData });
        if (!res.ok) throw new Error("Datos incorrectos");
        const data = await res.json(); token = data.access_token; localStorage.setItem('token', token); iniciarApp();
      } catch (e) { mostrarAuthError(e.message); }
    }
    async function handleRegister(e) {
      e.preventDefault();
      const data = { email: document.getElementById('reg-email').value, password: document.getElementById('reg-pass').value, nombre_completo: document.getElementById('reg-name').value };
      try {
        const res = await fetch(`${API_URL}/register`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
        if (!res.ok) { const err = await res.json(); throw new Error(err.detail); }
        alert("Cuenta creada. Inicia sesi칩n."); toggleAuth('login');
      } catch (e) { mostrarAuthError(e.message); }
    }
    function logout() { localStorage.removeItem('token'); location.reload(); }
    function mostrarAuthError(msg) { const el = document.getElementById('auth-error'); el.innerText = msg; el.style.display = 'block'; }
    async function apiFetch(endpoint, options = {}) {
      if (!options.headers) options.headers = {}; options.headers['Authorization'] = `Bearer ${token}`;
      const res = await fetch(`${API_URL}${endpoint}`, options); if (res.status === 401) logout(); return res;
    }

    // --- L칍GICA APP ---
    function iniciarApp() {
      document.getElementById('auth-container').style.display = 'none';
      document.getElementById('app-container').style.display = 'block';
      if (!map) {
        // Usamos 'streets-v12' que es m치s moderno y soporta tr치fico
        map = new mapboxgl.Map({ container: 'map', style: 'mapbox://styles/mapbox/streets-v12', center: [-69.97, -15.84], zoom: 12 });
        
        map.on('load', () => {
             // --- CAPA DE TR츼FICO ---
             map.addSource('mapbox-traffic', { type: 'vector', url: 'mapbox://mapbox.mapbox-traffic-v1' });
             map.addLayer({
               'id': 'traffic',
               'type': 'line',
               'source': 'mapbox-traffic',
               'source-layer': 'traffic',
               'paint': {
                 'line-width': 2,
                 'line-color': [
                   'case',
                   ['==', 'low', ['get', 'congestion']], '#32CD32',      // Verde
                   ['==', 'moderate', ['get', 'congestion']], '#FFA500', // Naranja
                   ['==', 'heavy', ['get', 'congestion']], '#FF0000',    // Rojo
                   ['==', 'severe', ['get', 'congestion']], '#8B0000',   // Rojo oscuro
                   '#000000'
                 ]
               }
             });

             cargarParadasDisponibles(); cargarRutasGuardadas(); obtenerUbicacionAutomatica();
        });
        map.on('click', handleMapClick);
      }
    }

    // --- CRUD Y MAPA (Sin cambios l칩gicos) ---
    async function cargarParadasDisponibles() {
      try {
        const res = await apiFetch('/paradas/'); paradasGlobal = await res.json();
        const container = document.getElementById("lista-paradas"); container.innerHTML = "";
        if (paradasGlobal.length === 0) { container.innerHTML = '<small class="text-muted">Sin destinos.</small>'; return; }
        paradasGlobal.forEach(p => {
          container.innerHTML += `<div class="parada-item"><div class="form-check"><input class="form-check-input parada-checkbox" type="checkbox" value="${p.id}" id="parada-${p.id}"><label class="form-check-label" for="parada-${p.id}">${p.nombre}</label></div><div class="btn-group btn-group-sm"><button class="btn btn-outline-secondary" onclick="abrirModalEditarParada(${p.id})"><i class="bi bi-pencil-fill"></i></button><button class="btn btn-outline-danger" onclick="handleBorrarParada(${p.id}, '${p.nombre}')"><i class="bi bi-trash-fill"></i></button></div></div>`;
        });
      } catch (e) {}
    }
    async function handleGuardarParada(e) {
      e.preventDefault();
      const pid = document.getElementById("paradaId").value;
      const data = { nombre: document.getElementById("paradaNombre").value, lat: parseFloat(document.getElementById("paradaLat").value), lng: parseFloat(document.getElementById("paradaLng").value), ventana_inicio: document.getElementById("paradaInicio").value + ":00", ventana_fin: document.getElementById("paradaFin").value + ":00", tiempo_servicio_min: parseInt(document.getElementById("paradaServicio").value) };
      try {
        let url = '/paradas/', method = 'POST'; if (pid) { url = `/paradas/${pid}`; method = 'PATCH'; }
        const res = await apiFetch(url, { method: method, headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
        if (!res.ok) throw new Error("Error"); 
        if(tempSearchMarker) { tempSearchMarker.remove(); tempSearchMarker = null; }
        paradaModal.hide(); cargarParadasDisponibles();
      } catch(err) { alert(err.message); }
    }
    async function handleBorrarParada(id, n) { if(!confirm("쮹orrar?")) return; await apiFetch(`/paradas/${id}`, { method: 'DELETE' }); cargarParadasDisponibles(); }
    async function cargarRutasGuardadas() { const res = await apiFetch('/rutas/'); rutasGlobal = await res.json(); const s = document.getElementById('select-ruta-guardada'); s.innerHTML = '<option value="">-- Mis Rutas --</option>'; rutasGlobal.forEach(r => s.innerHTML += `<option value="${r.id}">${r.nombre}</option>`); }
    async function handleGuardarRuta() { const n = prompt("Nombre:"); if(!n) return; try { const res = await apiFetch('/rutas/', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ nombre: n, parada_ids: paradasOptimizadasActuales }) }); if(res.ok) { alert("Guardada"); cargarRutasGuardadas(); } } catch(e) { alert("Error"); } }
    function handleCargarRuta(e) { const rid = parseInt(e.target.value); const r = rutasGlobal.find(x => x.id === rid); if(!r) return; limpiarPlan(false); r.paradas.forEach(p => { const c = document.getElementById(`parada-${p.id}`); if(c) c.checked = true; }); }
    
    async function handleOptimizar() {
      if(!userStartLocation) { alert("Sin ubicaci칩n"); return; }
      const s = Array.from(document.querySelectorAll(".parada-checkbox:checked")).map(c => parseInt(c.value));
      if(s.length === 0) return;
      document.getElementById("loading").style.display = "flex"; limpiarPlan(false); paradasOptimizadasActuales = s;
      try {
        const res = await apiFetch('/api/v2/optimizar-ruta', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ start_lat: userStartLocation.lat, start_lng: userStartLocation.lng, parada_ids: s }) });
        const data = await res.json(); if(!res.ok) throw new Error(data.detail);
        mostrarItinerario(data); document.getElementById("btn-guardar-ruta").style.display = "block"; dibujarRutaEnMapa(data.stops.map(x => x.parada));
      } catch(e) { document.getElementById("itinerario-error").innerText = e.message; document.getElementById("itinerario-error").style.display = "block"; } finally { document.getElementById("loading").style.display = "none"; }
    }

    function handleMapClick(e) {
        if (isPinningLocation) { 
            document.getElementById("paradaLat").value = e.lngLat.lat.toFixed(6); 
            document.getElementById("paradaLng").value = e.lngLat.lng.toFixed(6); 
            isPinningLocation = false; document.getElementById("pin-instruction").style.display = "none"; 
            map.getCanvas().classList.remove('crosshair-cursor'); paradaModal.show(); 
        } else if (!userStartLocation) { 
            userStartLocation = e.lngLat; 
            if (startMarker) startMarker.setLngLat(e.lngLat); 
            else startMarker = new mapboxgl.Marker({color:"green"}).setLngLat(e.lngLat).addTo(map); 
            document.getElementById("start-coords").innerText = "Ubicaci칩n Manual"; 
        }
    }
    function obtenerUbicacionAutomatica() { if(!navigator.geolocation) return; navigator.geolocation.watchPosition(pos => { const {latitude: lat, longitude: lng} = pos.coords; userStartLocation = {lat, lng}; document.getElementById("start-coords").innerText = "GPS Activo"; if(startMarker) startMarker.setLngLat([lng, lat]); else { startMarker = new mapboxgl.Marker({color:"green"}).setLngLat([lng, lat]).addTo(map); map.flyTo({center:[lng, lat], zoom:14}); } }); }
    function abrirModalNuevaParada() { document.getElementById("paradaForm").reset(); document.getElementById("paradaId").value=""; document.getElementById("geocode-results").innerHTML=""; paradaModal.show(); }
    function abrirModalEditarParada(id) { const p = paradasGlobal.find(x => x.id === id); if(!p) return; document.getElementById("paradaId").value = p.id; document.getElementById("paradaNombre").value = p.nombre; document.getElementById("paradaLat").value = p.lat; document.getElementById("paradaLng").value = p.lng; document.getElementById("paradaInicio").value = p.ventana_inicio; document.getElementById("paradaFin").value = p.ventana_fin; paradaModal.show(); }
    function startPinningLocation() { isPinningLocation=true; paradaModal.hide(); document.getElementById("pin-instruction").style.display="block"; map.getCanvas().classList.add('crosshair-cursor'); }
    
    async function handleGeocodeSearch() {
        const q = document.getElementById("geocode-search-query").value; if (!q) return;
        const resultsContainer = document.getElementById("geocode-results"); resultsContainer.innerHTML = '<div class="text-muted p-2">Buscando...</div>';
        try {
            const bbox = "-71.0,-16.5,-68.5,-13.0"; 
            const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(q)}.json?access_token=${MAPBOX_TOKEN}&country=PE&bbox=${bbox}&types=poi,address,place,neighborhood&limit=5`;
            const response = await fetch(url); const data = await response.json();
            if (data.features && data.features.length > 0) {
                resultsContainer.innerHTML = data.features.map(f => {
                    const safeName = f.text.replace(/'/g, "\\'"); const safeAddress = (f.place_name || "").replace(/'/g, "\\'");
                    return `<div class="geocode-result-item" onclick="selectGeocodeResult(${f.center[0]}, ${f.center[1]}, '${safeName}', '${safeAddress}')"><strong>${f.text}</strong><br><small>${f.properties.address || f.context?.map(c => c.text).join(', ') || ""}</small></div>`;
                }).join('');
            } else { resultsContainer.innerHTML = '<div class="text-muted p-2">Sin resultados.</div>'; }
        } catch (error) { resultsContainer.innerHTML = '<div class="text-danger p-2">Error.</div>'; }
    }

    function selectGeocodeResult(lng, lat, shortName, fullName) {
        document.getElementById("paradaNombre").value = shortName;
        document.getElementById("paradaLat").value = lat.toFixed(6); document.getElementById("paradaLng").value = lng.toFixed(6);
        document.getElementById("geocode-results").innerHTML = ""; document.getElementById("geocode-search-query").value = "";
        map.flyTo({ center: [lng, lat], zoom: 16 });
        if (tempSearchMarker) tempSearchMarker.remove();
        tempSearchMarker = new mapboxgl.Marker({ color: "#FFAA00" }).setLngLat([lng, lat]).setPopup(new mapboxgl.Popup().setText(shortName)).addTo(map).togglePopup();
    }

    function limpiarPlan(chk=true) { if(map.getSource('route')) { map.removeLayer('route'); map.removeSource('route'); } document.querySelectorAll('.marker-p').forEach(m => m.remove()); document.getElementById("itinerario-lista").innerHTML=""; document.getElementById("btn-guardar-ruta").style.display="none"; if(chk) { document.querySelectorAll(".parada-checkbox").forEach(c => c.checked=false); document.getElementById("select-ruta-guardada").value=""; } }
    let markers = [];
    async function dibujarRutaEnMapa(paradas) { markers.forEach(m => m.remove()); markers=[]; if(map.getSource('route')) { map.removeLayer('route'); map.removeSource('route'); } paradas.forEach((p, i) => { if(i===0) return; const el = document.createElement('div'); el.className = 'marker-p'; const m = new mapboxgl.Marker({color:"red"}).setLngLat([p.lng, p.lat]).setPopup(new mapboxgl.Popup().setText(p.nombre)).addTo(map); markers.push(m); }); const coords = paradas.map(p => `${p.lng},${p.lat}`).join(';'); const res = await fetch(`https://api.mapbox.com/directions/v5/mapbox/driving-traffic/${coords}?geometries=geojson&overview=full&access_token=${MAPBOX_TOKEN}`); const data = await res.json(); map.addSource('route', {type: 'geojson', data: {type: 'Feature', geometry: data.routes[0].geometry}}); map.addLayer({id: 'route', type: 'line', source: 'route', layout: {'line-join': 'round', 'line-cap': 'round'}, paint: {'line-color': '#3887be', 'line-width': 5}}); const bounds = new mapboxgl.LngLatBounds(); paradas.forEach(p => bounds.extend([p.lng, p.lat])); map.fitBounds(bounds, {padding: 50}); }
    function mostrarItinerario(data) { document.getElementById("itinerario-lista").innerHTML = data.stops.map((s, i) => `<div class="itinerary-item-clickable" onclick="map.flyTo({center:[${s.parada.lng},${s.parada.lat}],zoom:15})"><b>${i}. ${s.parada.nombre}</b><br><small>Llegada: ${s.arrival_time}</small></div>`).join(''); }
  </script>
</body>
</html>