<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Optimizador de Rutas v2.0 (CRUD)</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.2.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.2.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
  <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css" type="text/css">
  
  <style>
    /* (Estilos sin cambios) */
    body, html { height: 100%; margin: 0; }
    #map { height: 100%; }
    .sidebar {
      position: absolute; top: 10px; left: 10px; width: 350px;
      background: rgba(255, 255, 255, 0.95); padding: 15px;
      border-radius: 8px; z-index: 10; max-height: calc(100vh - 20px);
      overflow-y: auto;
    }
    .loading-overlay {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5); z-index: 20; display: none;
      justify-content: center; align-items: center;
    }
    .itinerary-item { padding: 10px; border-bottom: 1px solid #eee; }
    .itinerary-item-clickable { cursor: pointer; transition: background-color 0.2s; }
    .itinerary-item-clickable:hover { background-color: #f8f9fa; }
    .itinerary-item .time-info { font-size: 0.9rem; color: #007bff; }
    .itinerary-item .travel-info { font-size: 0.8rem; color: #6c757d; }
    .parada-item {
      display: flex; justify-content: space-between;
      align-items: center; padding: 8px 5px;
      border-bottom: 1px solid #f0f0f0;
    }
    .parada-item .btn-group { flex-shrink: 0; }
    .crosshair-cursor { cursor: crosshair !important; }
    .geocode-result-item {
      padding: 8px 12px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      font-size: 0.9rem;
    }
    .geocode-result-item:hover { background-color: #f0f0f0; }
    .geocode-result-item small { color: #6c757d; }
  </style>
</head>
<body>

  <div id="map"></div>
  <div class="loading-overlay text-white" id="loading">
    <div class="spinner-border" role="status"></div>
    <h4 class="ms-3">Optimizando...</h4>
  </div>

  <div class="sidebar shadow">
    <h5><b class="text-primary">Optimizador de Rutas Puno v2.0</b></h5>
    <hr>
    
    <h6>1. Tu punto de inicio (GPS)</h6>
    <small id="start-coords" class="text-muted">Activando GPS...</small>
    <div id="pin-instruction" class"alert alert-info" style="display:none; margin-top: 10px; font-weight: bold;">
      <i class="bi bi-geo-alt-fill"></i> Haz clic en el mapa para fijar la parada...
    </div>

    <h6 class="mt-3">Cargar Ruta Guardada</h6>
    <select id="select-ruta-guardada" class="form-select">
      <option value="">-- Selecciona una ruta --</option>
      </select>
    
    <h6 class="mt-3">2. Selecciona tus destinos</h6>
    <div id="lista-paradas">
      <small class="text-muted">Cargando paradas...</small>
    </div>
    <div class="d-grid mt-2">
      <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#paradaModal" onclick="abrirModalNuevaParada()">
        <i class="bi bi-plus-circle-fill"></i> Añadir Nueva Parada
      </button>
    </div>

    <div class="row g-2 mt-3">
      <div class="col">
        <button id="btn-optimizar" class="btn btn-primary fw-bold w-100"><i class="bi bi-broadcast"></i> Optimizar</button>
      </div>
      <div class="col">
        <button id="btn-limpiar" class="btn btn-outline-danger w-100"><i class="bi bi-x-circle"></i> Limpiar</button>
      </div>
    </div>

    <hr>
    <h6>3. Tu Itinerario Optimizado</h6>
    
    <div class="d-grid mb-2">
      <button id="btn-guardar-ruta" class="btn btn-info" style="display: none;">
        <i class="bi bi-save-fill"></i> Guardar Ruta Actual
      </button>
    </div>

    <div id="itinerario-total" class="alert alert-primary" style="display:none;"></div>
    <div id="itinerario-error" class="alert alert-danger" style="display:none;"></div>
    <div id="itinerario-lista" class="list-group">
      <small id="itinerario-placeholder" class="text-muted">Aquí aparecerá tu plan de viaje...</small>
    </div>
  </div>

  <div class="modal fade" id="paradaModal" tabindex="-1" aria-hidden="true">
     <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">Añadir Nueva Parada</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="paradaForm" onsubmit="handleGuardarParada(event)">
            <input type="hidden" id="paradaId" value="">
            <label class="form-label">Buscar por nombre o dirección:</label>
            <div class="input-group mb-3">
              <input type="text" class="form-control" id="geocode-search-query" placeholder="Ej: Catedral de Puno">
              <button class="btn btn-outline-secondary" type="button" id="btn-geocode-search">
                <i class="bi bi-search"></i>
              </button>
            </div>
            <div id="geocode-results" class="list-group mb-3" style="max-height: 200px; overflow-y: auto;"></div>
            <div class="mb-2">
              <label for="paradaNombre" class="form-label">Nombre</label>
              <input type="text" class="form-control" id="paradaNombre" required>
            </div>
            <div class="d-grid mb-2">
              <button type="button" class="btn btn-secondary btn-sm" id="btn-pin-map">
                <i class="bi bi-geo-alt-fill"></i> O, Obtener Coordenadas del Mapa
              </button>
            </div>
            <div class="row">
              <div class="col-6 mb-2"><label for="paradaLat" class="form-label">Latitud</label><input type="number" step="any" class="form-control" id="paradaLat" required></div>
              <div class="col-6 mb-2"><label for="paradaLng" class="form-label">Longitud</label><input type="number" step="any" class="form-control" id="paradaLng" required></div>
            </div>
            <div class="row">
              <div class="col-6 mb-2"><label for="paradaInicio" class="form-label">Apertura (ej: 09:00)</label><input type="time" class="form-control" id="paradaInicio" required></div>
              <div class="col-6 mb-2"><label for="paradaFin" class="form-label">Cierre (ej: 17:00)</label><input type="time" class="form-control" id="paradaFin" required></div>
            </div>
            <div class="mb-2"><label for="paradaServicio" class="form-label">Tiempo de Servicio (min)</label><input type="number" class="form-control" id="paradaServicio" value="30" required></div>
            <hr>
            <button type="submit" class="btn btn-primary">Guardar Cambios</button>
          </form>
        </div>
      </div>
    </div>
  </div>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // -----------------------------------------------------------------
    //  CONFIGURACIÓN Y GLOBALES
    // -----------------------------------------------------------------
    
    const MAPBOX_TOKEN = "pk.eyJ1IjoiamVmZjI2MTMyNiIsImEiOiJjbWh5aWgyeW4wMmVuMmtxYjVzb25xeHRhIn0.h8HOF9YxlXYJYnYATTX3Kg";
    const API_URL = "http://127.0.0.1:8000";

    mapboxgl.accessToken = MAPBOX_TOKEN;
    const map = new mapboxgl.Map({
      container: "map", style: "mapbox://styles/mapbox/streets-v11",
      center: [-69.9782, -15.8402], zoom: 11
    });

    let userStartLocation = null;
    let startMarker = null;
    let paradasGlobal = []; 
    let paradaMarkers = []; 
    let isPinningLocation = false;
    let paradaModal = null; 

    // ¡¡NUEVAS GLOBALES!!
    let rutasGlobal = []; // Caché para las rutas guardadas
    let paradasOptimizadasActuales = []; // Guarda los IDs de la ruta actual

    // -----------------------------------------------------------------
    //  INICIALIZACIÓN
    // -----------------------------------------------------------------
    document.addEventListener("DOMContentLoaded", () => {
      paradaModal = new bootstrap.Modal(document.getElementById('paradaModal'));
      
      cargarParadasDisponibles();
      cargarRutasGuardadas(); // <-- ¡NUEVO! Cargar rutas al inicio
      obtenerUbicacionAutomatica();
      
      // Conectar listeners de botones
      document.getElementById("paradaForm").addEventListener("submit", handleGuardarParada);
      document.getElementById("btn-optimizar").addEventListener("click", handleOptimizar);
      document.getElementById("btn-limpiar").addEventListener("click", limpiarPlan);
      document.getElementById("btn-pin-map").addEventListener("click", startPinningLocation);
      document.getElementById("btn-geocode-search").addEventListener("click", handleGeocodeSearch);
      
      // ¡¡NUEVOS LISTENERS!!
      document.getElementById("select-ruta-guardada").addEventListener("change", handleCargarRuta);
      document.getElementById("btn-guardar-ruta").addEventListener("click", handleGuardarRuta);
    });
    
    // -----------------------------------------------------------------
    //  ¡¡NUEVAS FUNCIONES DE GUARDAR/CARGAR RUTA!!
    // -----------------------------------------------------------------
    async function cargarRutasGuardadas() {
      const select = document.getElementById("select-ruta-guardada");
      try {
        const response = await fetch(`${API_URL}/rutas/`);
        rutasGlobal = await response.json(); // Guardar en caché

        // Limpiar opciones anteriores
        select.innerHTML = '<option value="">-- Selecciona una ruta --</option>';

        if (rutasGlobal.length > 0) {
          rutasGlobal.forEach(ruta => {
            select.innerHTML += `<option value="${ruta.id}">${ruta.nombre}</option>`;
          });
        }
      } catch (error) {
        console.error("Error cargando rutas guardadas:", error);
      }
    }

    function handleCargarRuta(event) {
      const rutaId = parseInt(event.target.value);
      if (!rutaId) return;

      // Encontrar la ruta en nuestra caché
      const ruta = rutasGlobal.find(r => r.id === rutaId);
      if (!ruta) return;

      // Limpiar el plan actual
      limpiarPlan();

      // Obtener los IDs de las paradas de esta ruta
      const paradaIds = ruta.paradas.map(p => p.id);

      // Marcar los checkboxes correspondientes
      paradaIds.forEach(id => {
        const chk = document.getElementById(`parada-${id}`);
        if (chk) {
          chk.checked = true;
        }
      });
    }

    async function handleGuardarRuta() {
      if (paradasOptimizadasActuales.length === 0) {
        alert("Primero debes optimizar una ruta para poder guardarla.");
        return;
      }
      
      const nombreRuta = prompt("Por favor, dale un nombre a esta ruta:", "Mi Ruta Favorita");
      
      if (!nombreRuta) return; // El usuario canceló

      const rutaData = {
        nombre: nombreRuta,
        parada_ids: paradasOptimizadasActuales
      };

      try {
        const response = await fetch(`${API_URL}/rutas/`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(rutaData)
        });

        if (!response.ok) {
          const err = await response.json();
          throw new Error(err.detail || "Error al guardar la ruta");
        }

        alert(`Ruta "${nombreRuta}" guardada exitosamente.`);
        cargarRutasGuardadas(); // Recargar el dropdown
        
      } catch (error) {
        alert(`Error: ${error.message}`);
      }
    }

    // -----------------------------------------------------------------
    //  LÓGICA DE GESTIÓN DE PARADAS (CRUD) (Sin cambios)
    // -----------------------------------------------------------------
    async function cargarParadasDisponibles() {
      // (sin cambios)
      const container = document.getElementById("lista-paradas");
      try {
        const response = await fetch(`${API_URL}/paradas/`);
        paradasGlobal = await response.json(); 
        container.innerHTML = ""; 
        if (paradasGlobal.length === 0) {
          container.innerHTML = '<small class="text-muted">No hay paradas en la BD.</small>'; return;
        }
        paradasGlobal.forEach(parada => {
          container.innerHTML += `
            <div class="parada-item">
              <div class="form-check"><input class="form-check-input parada-checkbox" type="checkbox" value="${parada.id}" id="parada-${parada.id}"><label class="form-check-label" for="parada-${parada.id}"><b>${parada.nombre}</b></label></div>
              <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-secondary" onclick="abrirModalEditarParada(${parada.id})"><i class="bi bi-pencil-fill"></i></button>
                <button class="btn btn-outline-danger" onclick="handleBorrarParada(${parada.id}, '${parada.nombre}')"><i class="bi bi-trash-fill"></i></button>
              </div>
            </div>`;
        });
      } catch (error) { container.innerHTML = '<small class="text-danger">Error al conectar con la API.</small>'; }
    }
    function abrirModalNuevaParada() {
      // (sin cambios)
      document.getElementById("paradaForm").reset(); document.getElementById("paradaId").value = "";
      document.getElementById("modalTitle").innerText = "Añadir Nueva Parada";
      document.getElementById("geocode-results").innerHTML = "";
    }
    function abrirModalEditarParada(id) {
      // (sin cambios)
      const parada = paradasGlobal.find(p => p.id === id); if (!parada) return;
      document.getElementById("paradaId").value = parada.id;
      document.getElementById("paradaNombre").value = parada.nombre;
      document.getElementById("paradaLat").value = parada.lat;
      document.getElementById("paradaLng").value = parada.lng;
      document.getElementById("paradaInicio").value = parada.ventana_inicio;
      document.getElementById("paradaFin").value = parada.ventana_fin;
      document.getElementById("paradaServicio").value = parada.tiempo_servicio_min;
      document.getElementById("modalTitle").innerText = "Editar Parada";
      document.getElementById("geocode-results").innerHTML = "";
      paradaModal.show();
    }
    async function handleGuardarParada(event) {
      // (sin cambios)
      event.preventDefault(); 
      const paradaId = document.getElementById("paradaId").value;
      const paradaData = {
        nombre: document.getElementById("paradaNombre").value, lat: parseFloat(document.getElementById("paradaLat").value),
        lng: parseFloat(document.getElementById("paradaLng").value), ventana_inicio: document.getElementById("paradaInicio").value + ":00",
        ventana_fin: document.getElementById("paradaFin").value + ":00", tiempo_servicio_min: parseInt(document.getElementById("paradaServicio").value)
      };
      let url = `${API_URL}/paradas/`; let method = 'POST';
      if (paradaId) { url = `${API_URL}/paradas/${paradaId}`; method = 'PATCH'; }
      try {
        const response = await fetch(url, { method: method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(paradaData) });
        if (!response.ok) { const err = await response.json(); throw new Error(err.detail || "Error al guardar"); }
        paradaModal.hide(); cargarParadasDisponibles(); 
      } catch (error) { alert(`Error: ${error.message}`); }
    }
    async function handleBorrarParada(id, nombre) {
      // (sin cambios)
      if (!confirm(`¿Estás seguro de que quieres borrar la parada "${nombre}"?`)) { return; }
      try {
        const response = await fetch(`${API_URL}/paradas/${id}`, { method: 'DELETE' });
        if (!response.ok) { const err = await response.json(); throw new Error(err.detail || "Error al borrar"); }
        cargarParadasDisponibles(); 
      } catch (error) { alert(`Error: ${error.message}`); }
    }
    
    // -----------------------------------------------------------------
    //  LÓGICA DE GEOCODIFICACIÓN (Sin cambios)
    // -----------------------------------------------------------------
    async function handleGeocodeSearch() {
      // (sin cambios)
      const query = document.getElementById("geocode-search-query").value; if (!query) return;
      const resultsContainer = document.getElementById("geocode-results");
      resultsContainer.innerHTML = "Buscando...";
      try {
        const center = map.getCenter(); const proximity = `${center.lng},${center.lat}`;
        const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(query)}.json?access_token=${MAPBOX_TOKEN}&country=PE&proximity=${proximity}&types=poi,address,place&limit=5`;
        const response = await fetch(url); if (!response.ok) { throw new Error("Respuesta de red no fue OK"); }
        const data = await response.json();
        if (data && data.features && data.features.length > 0) {
          resultsContainer.innerHTML = "";
          data.features.forEach(feature => {
            const placeName = feature.place_name; const [lng, lat] = feature.geometry.coordinates;
            resultsContainer.innerHTML += `<div class="geocode-result-item" onclick="selectGeocodeResult(${lng}, ${lat}, '${placeName.replace(/'/g, "\\'")}')"><b>${feature.text}</b><br><small>${placeName}</small></div>`;
          });
        } else { resultsContainer.innerHTML = '<small class="p-2 text-muted">No se encontraron resultados.</small>'; }
      } catch (error) { console.error("Error de geocodificación:", error); resultsContainer.innerHTML = '<small class="p-2 text-danger">Error al buscar.</small>'; }
    }
    function selectGeocodeResult(lng, lat, placeName) {
      // (sin cambios)
      document.getElementById("paradaNombre").value = placeName;
      document.getElementById("paradaLat").value = lat.toFixed(6);
      document.getElementById("paradaLng").value = lng.toFixed(6);
      document.getElementById("geocode-results").innerHTML = "";
      document.getElementById("geocode-search-query").value = "";
      flyToStop(lng, lat);
    }
    function startPinningLocation() {
      // (sin cambios)
      isPinningLocation = true; paradaModal.hide();
      document.getElementById("pin-instruction").style.display = "block";
      map.getCanvas().classList.add('crosshair-cursor');
    }
    function stopPinningLocation() {
      // (sin cambios)
      isPinningLocation = false;
      document.getElementById("pin-instruction").style.display = "none";
      map.getCanvas().classList.remove('crosshair-cursor');
    }
    
    // -----------------------------------------------------------------
    //  LÓGICA DE GPS Y CLIC EN MAPA (Sin cambios)
    // -----------------------------------------------------------------
    function obtenerUbicacionAutomatica() {
      // (sin cambios)
      const coordsStatus = document.getElementById('start-coords');
      if (!navigator.geolocation) { coordsStatus.innerText = 'GPS no soportado.'; return; }
      const options = { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 };
      navigator.geolocation.watchPosition(
        (position) => {
          const { latitude, longitude } = position.coords; const lngLat = [longitude, latitude]; 
          userStartLocation = { lat: latitude, lng: longitude }; 
          coordsStatus.innerText = `Lng: ${longitude.toFixed(4)}, Lat: ${latitude.toFixed(4)}`;
          if (startMarker) { startMarker.setLngLat(lngLat); } 
          else {
            startMarker = new mapboxgl.Marker({ color: "green" }).setLngLat(lngLat).setPopup(new mapboxgl.Popup().setText("Tu inicio (GPS)")).addTo(map);
            map.flyTo({ center: lngLat, zoom: 15 });
          }
        }, (error) => { console.error("Error de GPS:", error.message); coordsStatus.innerText = 'GPS falló. Haz clic en el mapa.'; }, options
      );
    }

    map.on('click', (e) => {
      // (sin cambios)
      if (isPinningLocation) {
        const { lng, lat } = e.lngLat;
        document.getElementById("paradaLat").value = lat.toFixed(6);
        document.getElementById("paradaLng").value = lng.toFixed(6);
        stopPinningLocation();
        paradaModal.show();
      }
      else if (!userStartLocation) {
        const lngLat = [e.lngLat.lng, e.lngLat.lat];
        userStartLocation = e.lngLat;
        document.getElementById('start-coords').innerText = `Lng: ${e.lngLat.lng.toFixed(4)}, Lat: ${e.lngLat.lat.toFixed(4)}`;
        if (startMarker) { startMarker.setLngLat(lngLat); } 
        else { startMarker = new mapboxgl.Marker({ color: "green" }).setLngLat(lngLat).setPopup(new mapboxgl.Popup().setText("Inicio (Manual)")).addTo(map); }
      }
    });

    // -----------------------------------------------------------------
    //  LÓGICA DE OPTIMIZACIÓN (¡MODIFICADA!)
    // -----------------------------------------------------------------
    async function handleOptimizar() {
      // (Lógica de validación sin cambios)
      if (!userStartLocation) { alert("No se pudo obtener tu ubicación."); return; }
      const paradasSeleccionadas = Array.from(document.querySelectorAll(".parada-checkbox:checked"))
                                        .map(chk => parseInt(chk.value));
      if (paradasSeleccionadas.length === 0) { alert("Por favor, selecciona al menos un destino."); return; }
      
      document.getElementById("loading").style.display = "flex";
      limpiarPlan(false); // <-- ¡MODIFICADO! Limpiamos, pero NO los checkboxes

      const requestBody = {
        start_lat: userStartLocation.lat,
        start_lng: userStartLocation.lng,
        parada_ids: paradasSeleccionadas
      };
      
      // ¡¡NUEVO!! Guardar los IDs para el botón "Guardar"
      paradasOptimizadasActuales = paradasSeleccionadas;

      try {
        const response = await fetch(`${API_URL}/api/v2/optimizar-ruta`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestBody)
        });
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.detail || `Error ${response.status}`);
        }
        
        const optimizacion = await response.json(); 
        mostrarItinerario(optimizacion);
        
        // ¡¡NUEVO!! Mostrar el botón de Guardar
        document.getElementById("btn-guardar-ruta").style.display = "block";

        const paradasOrdenadas = optimizacion.stops.map(s => s.parada);
        await dibujarRutaEnMapa(paradasOrdenadas);
      } catch (error) {
        // (Manejo de error sin cambios)
        console.error("Error en la optimización:", error);
        const errorContainer = document.getElementById("itinerario-error");
        errorContainer.innerHTML = `<i class="bi bi-exclamation-triangle-fill"></i> <b>Error al Optimizar:</b><br>${error.message}`;
        errorContainer.style.display = "block";
      } finally {
        document.getElementById("loading").style.display = "none";
      }
    }

    // -----------------------------------------------------------------
    //  FUNCIONES DE DIBUJO Y LIMPIEZA
    // -----------------------------------------------------------------
    
    // ¡¡FUNCIÓN MODIFICADA!! Acepta un parámetro
    function limpiarPlan(limpiarCheckboxes = true) {
      limpiarMapa();
      
      document.getElementById("itinerario-lista").innerHTML = '<small id="itinerario-placeholder" class="text-muted">Aquí aparecerá tu plan de viaje...</small>';
      document.getElementById("itinerario-total").style.display = "none";
      document.getElementById("itinerario-error").style.display = "none";
      document.getElementById("btn-guardar-ruta").style.display = "none"; // Ocultar botón Guardar
      
      paradasOptimizadasActuales = []; // Limpiar ruta actual
      
      if (limpiarCheckboxes) {
        const checkboxes = document.querySelectorAll(".parada-checkbox");
        checkboxes.forEach(chk => chk.checked = false);
        // Resetear el dropdown de rutas guardadas
        document.getElementById("select-ruta-guardada").value = "";
      }
    }

    // ¡¡FUNCIÓN MODIFICADA!!
    function mostrarItinerario(data) {
      const listaContainer = document.getElementById("itinerario-lista");
      const totalContainer = document.getElementById("itinerario-total");
      listaContainer.innerHTML = ""; 
      totalContainer.innerHTML = `<b>Duración total del viaje: ${data.total_duration_str}</b>`;
      totalContainer.style.display = "block";
      
      data.stops.forEach((stop, index) => {
        const parada = stop.parada;
        // ¡¡LÍNEA MODIFICADA!!
        // Añadimos 'onclick' y 'data-lng'/'data-lat'
        let html = `
          <div 
            class="itinerary-item itinerary-item-clickable" 
            onclick="flyToStop(${parada.lng}, ${parada.lat})"
          >
            <h5>
              <span class="badge bg-primary me-2">${index}</span>
              ${parada.nombre}
            </h5>
            <div class="ps-4">
        `;
        // (El resto del HTML interno es igual)
        if (index > 0) { html += `<div class="travel-info"><i class="bi bi-car-front-fill"></i> Viaje: ${stop.travel_time_to_stop}</div>`; }
        html += `<div class="time-info"><i class="bi bi-box-arrow-in-right"></i> Llegada: <b>${stop.arrival_time}</b></div>
                 <div class="time-info"><i class="bi bi-box-arrow-left"></i> Salida: <b>${stop.departure_time}</b></div>
                 <small class="text-muted">(${parada.tiempo_servicio_min} min de servicio)</small>
               </div>
          </div>`;
        listaContainer.innerHTML += html;
      });
    }

    function flyToStop(lng, lat) {
      // (sin cambios)
      map.flyTo({ center: [lng, lat], zoom: 15, speed: 1.2 });
    }

    async function dibujarRutaEnMapa(paradasOrdenadas) {
      // (sin cambios)
      if (paradasOrdenadas.length < 2) return;
      // ¡¡MODIFICADO!! No limpiar el mapa aquí, se limpia en handleOptimizar
      // limpiarMapa(); 
      paradasOrdenadas.forEach((parada, index) => {
        if (index === 0) return;
        const marker = new mapboxgl.Marker({ color: "red" })
          .setLngLat([parada.lng, parada.lat])
          .setPopup(new mapboxgl.Popup().setText(`Parada #${index}: ${parada.nombre}`))
          .addTo(map);
        paradaMarkers.push(marker);
      });
      const coordinates = paradasOrdenadas.map(p => `${p.lng},${p.lat}`).join(';');
      const url = `https://api.mapbox.com/directions/v5/mapbox/driving-traffic/${coordinates}?geometries=geojson&overview=full&access_token=${MAPBOX_TOKEN}`;
      const response = await fetch(url);
      const data = await response.json();
      if (data.routes && data.routes.length > 0) {
        const routeGeoJSON = data.routes[0].geometry;
        if (map.getSource('route')) {
          map.getSource('route').setData({ type: 'Feature', geometry: routeGeoJSON });
        } else {
          map.addSource('route', { type: 'geojson', data: { type: 'Feature', geometry: routeGeoJSON } });
          map.addLayer({ id: 'route', type: 'line', source: 'route',
            layout: { 'line-join': 'round', 'line-cap': 'round' },
            paint: { 'line-color': '#3887be', 'line-width': 6 }
          });
        }
        const bounds = new mapboxgl.LngLatBounds();
        paradasOrdenadas.forEach(p => bounds.extend([p.lng, p.lat]));
        map.fitBounds(bounds, { padding: 80 });
      }
    }
    
    function limpiarMapa() {
      // (sin cambios)
      if (map.getSource('route')) {
        map.removeLayer('route');
        map.removeSource('route');
      }
      for (let marker of paradaMarkers) {
        marker.remove();
      }
      paradaMarkers = [];
    }
  </script>

</body>
</html>